"use strict";function spring(t,n){function e(t){this.options=Object.assign({headers:{},body:null},t,o.config.globalFetchOptions),this.hasSend=!1,this.response=null,this.error=null,this.responseData=null}function i(t){function n(n){var i=n;return/^https?:\/\/.+$/g.test(n)||(i=o.config.baseURL+"/"+n),i=i.replace(/\/{2,}/g,"/").replace(/:\//g,"://"),new e({url:i,method:t})}return n}function r(t){return new Promise(function(n,e){if(s.isEntity(t))null==t.id?t.save().then(function(){n(t.href())})["catch"](function(t){e(t)}):n(t.href());else if(Array.isArray(t)){var i=[];for(var o in t)i.push(r(o));Promise.all(i).then(function(t){n(t)})["catch"](function(t){e(t)})}else if(null!=t&&t.constructor===Object){i=[];var a={},u=0;for(var c in t)t.hasOwnProperty(c)&&(a[u++]=c,i.push(r(t[c])));Promise.all(i).then(function(t){for(var e={},i=0;i<t.length;i++)e[a[i]]=t[i];n(e)})["catch"](function(t){e(t)})}else n(t)})}var o={};o.config={globalFetchOptions:{},baseURL:"/",fetchStartHook:null,fetchEndHook:null},e.prototype.queryParam=function(t){if(null!=t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push(e+"="+t[e]);this.options.url=this.options.url.split("?")[0]+"?"+n.join("&")}return this},e.prototype.jsonBody=function(t){return this.options.body=JSON.stringify(t),this.options.headers["Content-Type"]="application/json",this},e.prototype.formBody=function(t){var n=[];for(var e in t)t.hasOwnProperty(e)&&n.push(e+"="+t[e]);return this.options.body=n.join("&"),this.options.headers["Content-Type"]="application/x-www-form-urlencoded",this},e.prototype.send=function(){var t=this;return new Promise(function(e,i){if(t.hasSend)t.error?i(t):e(t.responseData);else{t.hasSend=!0;var r=o.config.fetchStartHook,s=o.config.fetchEndHook;r&&r(t),n(t.options.url,t.options).then(function(n){t.response=n;var e=n.headers.get("content-type");return null==e?Promise.resolve():/.*json.*/.test(e)?n.json():n.text()}).then(function(n){return t.responseData=n,t.response.ok?Promise.resolve(n):Promise.reject(n)}).then(function(n){s&&s(t),e(n)})["catch"](function(n){t.error=n,s&&s(t),i(t)})}})},e.prototype.then=function(t,n){return this.send().then(t)["catch"](n)},e.prototype.follow=function(t){var n=this;return new Promise(function(e,i){function r(s){var a=t.shift();if(a){var u=s._links,c=u[a];c?(c=c.href,o.get(c).send().then(function(t){r(t)})["catch"](function(t){i(t)})):(n.error="no key="+a+" \nin links="+JSON.stringify(u,null,4),i(n))}else e(s)}n.send().then(function(t){r(t)})["catch"](function(t){i(t)})})},o.get=i("GET"),o.post=i("POST"),o.patch=i("PATCH"),o.put=i("PUT"),o["delete"]=i("DELETE"),o.mockRequest=function(t){var n=t._links.self.href,i=new e({url:n,method:"GET"});return i.responseData=t,i.hasSend=!0,i},t.request=o;var s={};s.config={restBaseURL:"/"},s.isEntity=function(t){if(t){var n=t.href;return null!=n&&n.constructor===Function}return!1},s.extend=function(n){function e(n){var i=this;this.id=null,this._data={},this._modifyFileds=[],this.href=function(){var t;if(i._data&&(t=i._data._links),t)return t.self.href;if(i.id)return i.constructor.entityBaseURL+"/"+i.id;throw new Error("entity without id can't map to backend service:\n"+JSON.stringify(i))},this.get=function(t){return i._data[t]},this.set=function(t,n){this._modifyFileds.push(t),this._data[t]=n},this.data=function(){return i._data},this.patchData=function(t){for(var n in t)t.hasOwnProperty(n)&&this.set(n,t[n]);try{var e=t._links.self.href.split(/\//);e=e[e.length-1],null!=e&&(i.id=e)}catch(r){}},this._create=function(){return new Promise(function(t,n){r(i.data()).then(function(t){return o.post(i.constructor.entityBaseURL).jsonBody(t).send()}).then(function(n){i.patchData(n),t(n)})["catch"](function(t){n(t)})})},this._update=function(){for(var n={},e=this._data._links,a=[],u=0;u<i._modifyFileds.length;u++){var c=i._modifyFileds[u];if(!n.hasOwnProperty(c)&&"_"!==c[0]){var f=this.get(c);if(e[c]&&(s.isEntity(f)||Array.isArray(f)&&s.isEntity(f[0]))){f=r(f);var h=o.put(e[c].href).jsonBody(f);h.options.headers["Content-Type"]="text/uri-list",a.push(h.data())}else n[c]=f}}return new Promise(function(e,o){r(n).then(function(n){return a.unshift(t.request.patch(i.href()).jsonBody(n).send()),Promise.all(a)}).then(function(t){var n=t[0];i.patchData(n),e(n)})["catch"](function(t){o(t)})})},this.save=function(){return null!=i.id?i._update():i._create()},this["delete"]=function(){return e["delete"](i.id)},this.fetch=function(){return new Promise(function(t,n){e.findOne(i.id).then(function(n){var e=n.data();i.patchData(e),t(e)})["catch"](function(t){n(t)})})},this.follow=function(t){return new Promise(function(n,e){function r(){o.mockRequest(i._data).follow(t).then(function(t){n(t)})["catch"](function(t){e(t)})}i._modifyFileds.length>0?r():i.fetch().then(function(){r()})})},this.patchData(n)}function i(t){for(var n=[],i=t._embedded[e.entityName],r=0;r<i.length;r++)n.push(new e(i[r]));return n}return e.entityName=n,e.entityBaseURL=s.config.restBaseURL+"/"+e.entityName,e.findOne=function(t,n){if(t)return new Promise(function(i,r){o.get(e.entityBaseURL+"/"+t).queryParam(n).send().then(function(t){i(new e(t))})["catch"](function(t){r(t)})});throw new Error("require id")},e.findAll=function(t){return new Promise(function(n,r){o.get(e.entityBaseURL).queryParam(t).send().then(function(t){var e=i(t);e.page=t.page,n(e)})["catch"](function(t){r(t)})})},e.search=function(t,n){return new Promise(function(r,s){o.get(e.entityBaseURL+"/search/"+t).queryParam(n).send().then(function(t){try{r(i(t))}catch(n){r(new e(t))}})["catch"](function(t){s(t)})})},e["delete"]=function(t){return o["delete"](e.entityBaseURL+"/"+t).send()},e},t.entity=s}"undefined"==typeof exports?spring(window.spring={},window.fetch):module.exports=spring;
//# sourceMappingURL=dist/spring-data-rest.min.js.map